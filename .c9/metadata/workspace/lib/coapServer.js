{"changed":true,"filter":false,"title":"coapServer.js","tooltip":"/lib/coapServer.js","value":"'use strict';\n/////////////////////////////////////////\n//Use for motes to communicate to the cloud\n//EG Registration, requestion updates etc\n/////////////////////////////////////////\nvar coap = require(\"coap\");\nvar config = require('../config.js');\nvar qs    = require('qs');\nvar coapClient = require('./coapClient.js');\n\nfunction coapServer(logger, mongo, mqtt){\n    var coapRouter = require('./coapRouter');\n    var coapServer = coap.createServer();\n    \n    //coapServer.on('request', coapRouter.process);\n    coapServer.on('request', process);\n    coapServer.on('error', logger.error);\n    \n    config.coap_port = config.coap_port || 5683;\n    coapServer.listen(config.coap_port,\"0.0.0.0\",function(){\n        logger.info('CoAP is rocking on: coap://0.0.0.0:%s',config.coap_port);\n    });\n    \n    function process(req,res){\n        var data = {};\n        console.log(req);\n        data.method = req.method.toLowerCase();\n        data.url = req.url.replace(/\\u0000/g,'');\n        data.payload = req.payload.toString();\n        data.clientAddres = req.rsinfo.address;\n        data.clientPort = req.rsinfo.port;\n        data.content = formatContent(data.payload);\n        if(req.headers['Content-Format'] || req.headers['Content-Type']) \n            data.contentFormat = req.headers['Content-Format'] || req.headers['Content-Type'];\n        else\n            data.contentFormat = 'text/plain';\n        route(data,res);\n    }\n    \n    function route(data,res){\n        /////////////////////////////\n        //GET /\n        if(data.method === 'get' && data.url === '/'){\n            resJSON(data,res,205,{message: 'on-line'});res.statusCode = 205;\n        }\n        //////////////////////////////\n        //POST /register\n        else if(data.method === 'post' && data.url === '/register'){\n            mongo.registerMote(data.clientAddres,data.clientPort,data.content, function (err, mote){\n                if(err) resJSON(data,res, 402, err);\n                else {\n                    mqtt.publishRegister(mote);\n                    resJSON(data,res, 204, {message: 'acknowledged'});\n                    setTimeout(function(){\n                        //coapClient.discover(mote,function(err,resp){\n                           //if(err) logger.error(err)\n                           //if(!resp.online) logger.error(resp.message);\n                           //else \n                           coapClient.postRules(mote, logger);\n                        //});\n                    },5000);\n                }\n            });\n        }\n        /////////////////////////////\n        //POST /sense\n        else if(data.method === 'post' && data.url === '/sense'){\n            mongo.refreshMote(data.content, function(err){\n                if(err) resJSON(data,res, 402, err);\n                else {\n                    mqtt.publishSense(data.content);\n                    resJSON(data,res, 204, {message: 'acknowledged'});\n                }\n            });\n        }\n        ////////////////////////////\n        //POST /alert\n        else if(data.method === 'post' && data.url === '/alert'){\n            mongo.refreshMote(data.content, function(err){\n                if(err) resJSON(data,res, 402, err);\n                else {\n                    mqtt.publishAlert(data.content);\n                    resJSON(data,res, 204, {message: 'acknowledged'});\n                }\n            });\n        }\n        \n        else {\n            resJSON(data,res,404,{message: 'unknown resource'});   \n        }\n    }\n    \n    function resJSON(req, res,code,sendData){\n        res.setOption(\"Content-Format\", \"application/json\");\n        res.statusCode = code;\n        res.end(JSON.stringify(sendData));\n        logRequest(req,res, JSON.stringify(sendData));\n    }\n    \n    function logRequest(data,res, ret){\n        var msg = 'CoAP: Request';\n            msg += ': ' + data.method;\n            msg += ': ' + data.url;\n            msg += ': FROM: ' + data.clientAddres + ':' + data.clientPort;\n            msg += ' : payload: ' + data.payload;\n        logger.info(msg);\n        var resp = 'CoAP: Response: ' + res.statusCode + ' : ' + ret;\n        logger.info(resp);\n        \n    }\n    \n    function formatContent(data){\n        try {\n            return JSON.parse(data);   \n        }\n        catch(e) {\n            if(e instanceof SyntaxError) {\n                return qs.parse(data.toString().replace(/^\\/.*\\?/g, ''));\n            }\n            else return {};\n        }\n    }\n\n}\n\nmodule.exports = coapServer;","undoManager":{"stack":[[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["g"],"id":2495}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["e"],"id":2496}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["r"],"id":2497}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["."],"id":2498}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["e"],"id":2499}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["r"],"id":2500}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["r"],"id":2501}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["o"],"id":2502}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["r"],"id":2503}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["("],"id":2504}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["e"],"id":2505}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["r"],"id":2506}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["r"],"id":2507}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[")"],"id":2508}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[";"],"id":2509}],[{"start":{"row":58,"column":61},"end":{"row":59,"column":0},"action":"remove","lines":["",""],"id":2510}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2511}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2512}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2513}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2514}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2515}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2516}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2517}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2518}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2519}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2520}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2521}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2522}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2523}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2524}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2525}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2526}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2527}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2528}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2529}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2530}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2531}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2532}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2533}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2534}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2535}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2536}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2537}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2538}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2539}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2540}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2541}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["e"],"id":2542}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["l"],"id":2543}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["s"],"id":2544}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["e"],"id":2545}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2546}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["l"],"id":2547}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["o"],"id":2548}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["g"],"id":2549}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["g"],"id":2550}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["e"],"id":2551}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["r"],"id":2552}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["."],"id":2553}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["i"],"id":2554}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["n"],"id":2555}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["f"],"id":2556}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["o"],"id":2557}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["("],"id":2558}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["r"],"id":2559}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["e"],"id":2560}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["s"],"id":2561}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["p"],"id":2562}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["1"],"id":2563}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[")"],"id":2564}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[";"],"id":2565}],[{"start":{"row":58,"column":61},"end":{"row":59,"column":0},"action":"remove","lines":["",""],"id":2566}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2567}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2568}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2569}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2570}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2571}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2572}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2573}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2574}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2575}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2576}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2577}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2578}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2579}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2580}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2581}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2582}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2583}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2584}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2585}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2586}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2587}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2588}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2589}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2590}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2591}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2592}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[" "],"id":2593}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":["}"],"id":2594}],[{"start":{"row":58,"column":61},"end":{"row":58,"column":62},"action":"remove","lines":[")"],"id":2595}]],"mark":-67,"position":100},"ace":{"folds":[],"customSyntax":"javascript","scrolltop":468,"scrollleft":0,"selection":{"start":{"row":60,"column":28},"end":{"row":60,"column":28},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":20,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1432566347451}