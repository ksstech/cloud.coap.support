{"changed":true,"filter":false,"title":"coapServer.js","tooltip":"/lib/coapServer.js","value":"'use strict';\n/////////////////////////////////////////\n//Use for devices to communicate to the cloud\n//EG Registration, requestion updates etc\n/////////////////////////////////////////\nvar coap = require(\"coap\");\nvar config = require('../config.js');\nvar qs    = require('qs');\n\nfunction coapServer(logger, mongo, mqtt){\n    var coapRouter = require('./coapRouter');\n    var coapServer = coap.createServer();\n    \n    //coapServer.on('request', coapRouter.process);\n    coapServer.on('request', process);\n    coapServer.on('error', logger.error);\n    \n    config.coap_port = config.coap_port || 5683;\n    coapServer.listen(config.coap_port,\"0.0.0.0\",function(){\n        logger.info('CoAP is rocking on: coap://0.0.0.0:%s',config.coap_port);\n    });\n    \n    function process(req,res){\n        var data = {};\n        data.method = req.method.toLowerCase();\n        data.url = req.url;\n        data.payload = req.payload.toString();\n        data.clientAddres = req.rsinfo.address;\n        data.clientPort = req.rsinfo.port;\n        data.content = formatContent(data.payload);\n        if(req.headers['Content-Format'] || req.headers['Content-Type']) \n            data.contentFormat = req.headers['Content-Format'] || req.headers['Content-Type'];\n        else\n            data.contentFormat = 'text/plain';\n        route(data,res);\n    }\n    \n    function route(data,res){\n        /////////////////////////////\n        //GET /\n        if(data.method === 'get' && data.url === '/'){\n            resJSON(data,res,205,{message: 'on-line'});res.statusCode = 205;\n        }\n        //////////////////////////////\n        //POST /register\n        else if(data.method === 'post' && data.url === '/register'){\n            mongo.registerMote(data.clientAddres,data.clientPort,data.content, function (err, mote){\n                if(err) resJSON(data,res, 402, err);\n                else {\n                    mqtt.publishRegister(mote);\n                    resJSON(data,res, 204, {message: 'acknowledged'});\n                }\n            });\n        }\n        /////////////////////////////\n        //POST /sense\n        else if(data.method === 'post' && data.url === '/sense'){\n            mongo.refreshMote(data.content, function(err){\n                if(err) resJSON(data,res, 402, err);\n                else {\n                    mqtt.publishSense(data.content);\n                    resJSON(data,res, 204, {message: 'acknowledged'});\n                }\n            });\n        }\n        ////////////////////////////\n        //POST /alert\n        else if(data.method === 'post' && data.url === '/alert'){\n            mongo.refreshMote(data.content, function(err){\n                if(err) resJSON(data,res, 402, err);\n                else {\n                    mqtt.publishAlert(data.content);\n                    resJSON(data,res, 204, {message: 'acknowledged'});\n                }\n            });\n        }\n        \n        else {\n            resJSON(data,res,404,{message: 'unknown resource'});   \n        }\n    }\n    \n    function resJSON(req, res,code,sendData){\n        res.setOption(\"Content-Format\", \"application/json\");\n        res.statusCode = code;\n        res.end(JSON.stringify(sendData));\n        logRequest(req,res, JSON.stringify(sendData));\n    }\n    \n    function logRequest(data,res, ret){\n        var msg = 'CoAP: Request';\n            msg += ': ' + data.method;\n            msg += ': ' + data.url;\n            msg += ': FROM: ' + data.clientAddres + ':' + data.clientPort;\n            msg += ' : payload: ' + data.payload;\n        logger.info(msg);\n        var resp = 'CoAP: Response: ' + res.statusCode + ' : ' + ret;\n        logger.info(resp);\n        \n    }\n    \n    function formatContent(data){\n        try {\n            return JSON.parse(data);   \n        }\n        catch(e) {\n            if(e instanceof SyntaxError) {\n                return qs.parse(data.toString().replace(/^\\/.*\\?/g, ''));\n            }\n            else return {};\n        }\n    }\n\n}\n\nmodule.exports = coapServer;","undoManager":{"stack":[[{"start":{"row":55,"column":58},"end":{"row":57,"column":12},"action":"insert","lines":["","                ","            "],"id":1950}],[{"start":{"row":56,"column":16},"end":{"row":56,"column":17},"action":"insert","lines":["i"],"id":1951}],[{"start":{"row":56,"column":17},"end":{"row":56,"column":18},"action":"insert","lines":["f"],"id":1952}],[{"start":{"row":56,"column":18},"end":{"row":56,"column":20},"action":"insert","lines":["()"],"id":1953}],[{"start":{"row":56,"column":19},"end":{"row":56,"column":20},"action":"insert","lines":["e"],"id":1954}],[{"start":{"row":56,"column":20},"end":{"row":56,"column":21},"action":"insert","lines":["r"],"id":1955}],[{"start":{"row":56,"column":21},"end":{"row":56,"column":22},"action":"insert","lines":["r"],"id":1956}],[{"start":{"row":56,"column":23},"end":{"row":56,"column":24},"action":"insert","lines":[" "],"id":1957}],[{"start":{"row":56,"column":24},"end":{"row":56,"column":52},"action":"insert","lines":["resJSON(data,res, 402, err);"],"id":1958}],[{"start":{"row":56,"column":52},"end":{"row":57,"column":0},"action":"insert","lines":["",""],"id":1959},{"start":{"row":57,"column":0},"end":{"row":57,"column":16},"action":"insert","lines":["                "]}],[{"start":{"row":57,"column":16},"end":{"row":57,"column":17},"action":"insert","lines":["e"],"id":1960}],[{"start":{"row":57,"column":17},"end":{"row":57,"column":18},"action":"insert","lines":["l"],"id":1961}],[{"start":{"row":57,"column":18},"end":{"row":57,"column":19},"action":"insert","lines":["s"],"id":1962}],[{"start":{"row":57,"column":19},"end":{"row":57,"column":20},"action":"insert","lines":["e"],"id":1963}],[{"start":{"row":57,"column":20},"end":{"row":57,"column":21},"action":"insert","lines":[" "],"id":1964}],[{"start":{"row":59,"column":12},"end":{"row":59,"column":62},"action":"remove","lines":["resJSON(data,res, 204, {message: 'acknowledged'});"],"id":1965}],[{"start":{"row":57,"column":21},"end":{"row":57,"column":71},"action":"insert","lines":["resJSON(data,res, 204, {message: 'acknowledged'});"],"id":1966}],[{"start":{"row":59,"column":0},"end":{"row":59,"column":12},"action":"remove","lines":["            "],"id":1967}],[{"start":{"row":59,"column":0},"end":{"row":60,"column":0},"action":"remove","lines":["",""],"id":1968}],[{"start":{"row":58,"column":14},"end":{"row":58,"column":15},"action":"insert","lines":[";"],"id":1969}],[{"start":{"row":63,"column":12},"end":{"row":63,"column":62},"action":"remove","lines":["resJSON(data,res, 204, {message: 'acknowledged'});"],"id":1970},{"start":{"row":63,"column":12},"end":{"row":66,"column":15},"action":"insert","lines":["mongo.refreshMote(data.content, function(err){","                if(err) resJSON(data,res, 402, err);","                else resJSON(data,res, 204, {message: 'acknowledged'});","            });"]}],[{"start":{"row":57,"column":21},"end":{"row":57,"column":22},"action":"insert","lines":["{"],"id":1971}],[{"start":{"row":57,"column":22},"end":{"row":58,"column":0},"action":"insert","lines":["",""],"id":1972},{"start":{"row":58,"column":0},"end":{"row":58,"column":20},"action":"insert","lines":["                    "]}],[{"start":{"row":58,"column":70},"end":{"row":59,"column":0},"action":"insert","lines":["",""],"id":1973},{"start":{"row":59,"column":0},"end":{"row":59,"column":20},"action":"insert","lines":["                    "]}],[{"start":{"row":59,"column":20},"end":{"row":59,"column":21},"action":"insert","lines":["}"],"id":1974},{"start":{"row":59,"column":0},"end":{"row":59,"column":20},"action":"remove","lines":["                    "]},{"start":{"row":59,"column":0},"end":{"row":59,"column":16},"action":"insert","lines":["                "]}],[{"start":{"row":57,"column":22},"end":{"row":58,"column":0},"action":"insert","lines":["",""],"id":1975},{"start":{"row":58,"column":0},"end":{"row":58,"column":20},"action":"insert","lines":["                    "]}],[{"start":{"row":58,"column":20},"end":{"row":58,"column":47},"action":"insert","lines":["mqtt.publishRegister(mote);"],"id":1976}],[{"start":{"row":58,"column":32},"end":{"row":58,"column":33},"action":"insert","lines":["S"],"id":1977}],[{"start":{"row":58,"column":33},"end":{"row":58,"column":34},"action":"insert","lines":["e"],"id":1978}],[{"start":{"row":58,"column":34},"end":{"row":58,"column":35},"action":"insert","lines":["n"],"id":1979}],[{"start":{"row":58,"column":35},"end":{"row":58,"column":36},"action":"insert","lines":["s"],"id":1980}],[{"start":{"row":58,"column":36},"end":{"row":58,"column":37},"action":"insert","lines":["e"],"id":1981}],[{"start":{"row":58,"column":37},"end":{"row":58,"column":38},"action":"remove","lines":["R"],"id":1982}],[{"start":{"row":58,"column":37},"end":{"row":58,"column":38},"action":"remove","lines":["e"],"id":1983}],[{"start":{"row":58,"column":37},"end":{"row":58,"column":38},"action":"remove","lines":["g"],"id":1984}],[{"start":{"row":58,"column":37},"end":{"row":58,"column":38},"action":"remove","lines":["i"],"id":1985}],[{"start":{"row":58,"column":37},"end":{"row":58,"column":38},"action":"remove","lines":["s"],"id":1986}],[{"start":{"row":58,"column":37},"end":{"row":58,"column":38},"action":"remove","lines":["t"],"id":1987}],[{"start":{"row":58,"column":37},"end":{"row":58,"column":38},"action":"remove","lines":["e"],"id":1988}],[{"start":{"row":58,"column":37},"end":{"row":58,"column":38},"action":"remove","lines":["r"],"id":1989}],[{"start":{"row":58,"column":38},"end":{"row":58,"column":42},"action":"remove","lines":["mote"],"id":1990},{"start":{"row":58,"column":38},"end":{"row":58,"column":39},"action":"insert","lines":["d"]}],[{"start":{"row":58,"column":39},"end":{"row":58,"column":40},"action":"insert","lines":["a"],"id":1991}],[{"start":{"row":58,"column":40},"end":{"row":58,"column":41},"action":"insert","lines":["t"],"id":1992}],[{"start":{"row":58,"column":41},"end":{"row":58,"column":42},"action":"insert","lines":["a"],"id":1993}],[{"start":{"row":58,"column":42},"end":{"row":58,"column":43},"action":"insert","lines":["."],"id":1994}],[{"start":{"row":58,"column":43},"end":{"row":58,"column":44},"action":"insert","lines":["c"],"id":1995}],[{"start":{"row":58,"column":44},"end":{"row":58,"column":45},"action":"insert","lines":["o"],"id":1996}],[{"start":{"row":58,"column":45},"end":{"row":58,"column":46},"action":"insert","lines":["n"],"id":1997}],[{"start":{"row":58,"column":46},"end":{"row":58,"column":47},"action":"insert","lines":["t"],"id":1998}],[{"start":{"row":58,"column":47},"end":{"row":58,"column":48},"action":"insert","lines":["e"],"id":1999}],[{"start":{"row":58,"column":48},"end":{"row":58,"column":49},"action":"insert","lines":["n"],"id":2000}],[{"start":{"row":58,"column":49},"end":{"row":58,"column":50},"action":"insert","lines":["t"],"id":2001}],[{"start":{"row":68,"column":16},"end":{"row":68,"column":71},"action":"remove","lines":["else resJSON(data,res, 204, {message: 'acknowledged'});"],"id":2002},{"start":{"row":68,"column":16},"end":{"row":71,"column":17},"action":"insert","lines":["else {","                    mqtt.publishSense(data.content);","                    resJSON(data,res, 204, {message: 'acknowledged'});","                }"]}],[{"start":{"row":69,"column":32},"end":{"row":69,"column":33},"action":"insert","lines":["A"],"id":2003}],[{"start":{"row":69,"column":33},"end":{"row":69,"column":34},"action":"insert","lines":["l"],"id":2004}],[{"start":{"row":69,"column":34},"end":{"row":69,"column":35},"action":"insert","lines":["e"],"id":2005}],[{"start":{"row":69,"column":35},"end":{"row":69,"column":36},"action":"insert","lines":["r"],"id":2006}],[{"start":{"row":69,"column":36},"end":{"row":69,"column":37},"action":"insert","lines":["t"],"id":2007}],[{"start":{"row":69,"column":37},"end":{"row":69,"column":38},"action":"remove","lines":["S"],"id":2008}],[{"start":{"row":69,"column":37},"end":{"row":69,"column":38},"action":"remove","lines":["e"],"id":2009}],[{"start":{"row":69,"column":37},"end":{"row":69,"column":38},"action":"remove","lines":["n"],"id":2010}],[{"start":{"row":69,"column":37},"end":{"row":69,"column":38},"action":"remove","lines":["s"],"id":2011}],[{"start":{"row":69,"column":37},"end":{"row":69,"column":38},"action":"remove","lines":["e"],"id":2012}],[{"start":{"row":37,"column":29},"end":{"row":38,"column":0},"action":"insert","lines":["",""],"id":2013},{"start":{"row":38,"column":0},"end":{"row":38,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":38,"column":8},"end":{"row":38,"column":9},"action":"insert","lines":["/"],"id":2014}],[{"start":{"row":38,"column":9},"end":{"row":38,"column":10},"action":"insert","lines":["/"],"id":2015}],[{"start":{"row":38,"column":10},"end":{"row":38,"column":11},"action":"insert","lines":["/"],"id":2016}],[{"start":{"row":38,"column":11},"end":{"row":38,"column":12},"action":"insert","lines":["/"],"id":2017}],[{"start":{"row":38,"column":12},"end":{"row":38,"column":13},"action":"insert","lines":["/"],"id":2018}],[{"start":{"row":38,"column":13},"end":{"row":38,"column":14},"action":"insert","lines":["/"],"id":2019}],[{"start":{"row":38,"column":14},"end":{"row":38,"column":15},"action":"insert","lines":["/"],"id":2020}],[{"start":{"row":38,"column":15},"end":{"row":38,"column":16},"action":"insert","lines":["/"],"id":2021}],[{"start":{"row":38,"column":16},"end":{"row":38,"column":17},"action":"insert","lines":["/"],"id":2022}],[{"start":{"row":38,"column":17},"end":{"row":38,"column":18},"action":"insert","lines":["/"],"id":2023}],[{"start":{"row":38,"column":18},"end":{"row":38,"column":19},"action":"insert","lines":["/"],"id":2024}],[{"start":{"row":38,"column":19},"end":{"row":38,"column":20},"action":"insert","lines":["/"],"id":2025}],[{"start":{"row":38,"column":20},"end":{"row":38,"column":21},"action":"insert","lines":["/"],"id":2026}],[{"start":{"row":38,"column":21},"end":{"row":38,"column":22},"action":"insert","lines":["/"],"id":2027}],[{"start":{"row":38,"column":22},"end":{"row":38,"column":23},"action":"insert","lines":["/"],"id":2028}],[{"start":{"row":38,"column":23},"end":{"row":38,"column":24},"action":"insert","lines":["/"],"id":2029}],[{"start":{"row":38,"column":24},"end":{"row":38,"column":25},"action":"insert","lines":["/"],"id":2030}],[{"start":{"row":38,"column":25},"end":{"row":38,"column":26},"action":"insert","lines":["/"],"id":2031}],[{"start":{"row":38,"column":26},"end":{"row":38,"column":27},"action":"insert","lines":["/"],"id":2032}],[{"start":{"row":38,"column":27},"end":{"row":38,"column":28},"action":"insert","lines":["/"],"id":2033}],[{"start":{"row":38,"column":28},"end":{"row":38,"column":29},"action":"insert","lines":["/"],"id":2034}],[{"start":{"row":38,"column":29},"end":{"row":38,"column":30},"action":"insert","lines":["/"],"id":2035}],[{"start":{"row":38,"column":30},"end":{"row":38,"column":31},"action":"insert","lines":["/"],"id":2036}],[{"start":{"row":38,"column":31},"end":{"row":38,"column":32},"action":"insert","lines":["/"],"id":2037}],[{"start":{"row":38,"column":32},"end":{"row":38,"column":33},"action":"insert","lines":["/"],"id":2038}],[{"start":{"row":38,"column":33},"end":{"row":38,"column":34},"action":"insert","lines":["/"],"id":2039}],[{"start":{"row":38,"column":34},"end":{"row":38,"column":35},"action":"insert","lines":["/"],"id":2040}],[{"start":{"row":38,"column":35},"end":{"row":38,"column":36},"action":"insert","lines":["/"],"id":2041}],[{"start":{"row":38,"column":36},"end":{"row":38,"column":37},"action":"insert","lines":["/"],"id":2042}],[{"start":{"row":38,"column":37},"end":{"row":39,"column":0},"action":"insert","lines":["",""],"id":2043},{"start":{"row":39,"column":0},"end":{"row":39,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":39,"column":8},"end":{"row":39,"column":9},"action":"insert","lines":["/"],"id":2044}],[{"start":{"row":39,"column":9},"end":{"row":39,"column":10},"action":"insert","lines":["/"],"id":2045}],[{"start":{"row":39,"column":10},"end":{"row":39,"column":11},"action":"insert","lines":["G"],"id":2046}],[{"start":{"row":39,"column":11},"end":{"row":39,"column":12},"action":"insert","lines":["E"],"id":2047}],[{"start":{"row":39,"column":12},"end":{"row":39,"column":13},"action":"insert","lines":["T"],"id":2048}],[{"start":{"row":39,"column":13},"end":{"row":39,"column":14},"action":"insert","lines":[" "],"id":2049}],[{"start":{"row":39,"column":14},"end":{"row":39,"column":15},"action":"insert","lines":["/"],"id":2050}]],"mark":62,"position":100},"ace":{"folds":[],"scrolltop":212.5,"scrollleft":0,"selection":{"start":{"row":41,"column":33},"end":{"row":41,"column":53},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1432136377729}