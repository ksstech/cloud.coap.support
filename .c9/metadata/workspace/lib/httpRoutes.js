{"filter":false,"title":"httpRoutes.js","tooltip":"/lib/httpRoutes.js","undoManager":{"stack":[[{"start":{"row":107,"column":33},"end":{"row":107,"column":34},"action":"insert","lines":["r"]}],[{"start":{"row":107,"column":34},"end":{"row":107,"column":35},"action":"insert","lines":["s"]}],[{"start":{"row":107,"column":35},"end":{"row":107,"column":36},"action":"insert","lines":["e"]}],[{"start":{"row":107,"column":36},"end":{"row":107,"column":37},"action":"insert","lines":["("]}],[{"start":{"row":107,"column":63},"end":{"row":107,"column":64},"action":"insert","lines":[")"]}],[{"start":{"row":6,"column":0},"end":{"row":6,"column":32},"action":"remove","lines":["var data = require('./data.js');"],"id":2}],[{"start":{"row":6,"column":0},"end":{"row":7,"column":0},"action":"remove","lines":["",""],"id":3}],[{"start":{"row":1,"column":0},"end":{"row":5,"column":54},"action":"remove","lines":["var help = require('../help.js');","var u = require('./utils.js');","var devFind = require('./devicesFind.js');","var devUpdate = require('./devicesUpdate.js');","var devUnregister = require('./devicesUnregister.js');"],"id":4}],[{"start":{"row":1,"column":0},"end":{"row":2,"column":0},"action":"remove","lines":["",""],"id":5}],[{"start":{"row":147,"column":20},"end":{"row":147,"column":21},"action":"insert","lines":["l"],"id":6}],[{"start":{"row":147,"column":21},"end":{"row":147,"column":22},"action":"insert","lines":["o"],"id":7}],[{"start":{"row":147,"column":22},"end":{"row":147,"column":23},"action":"insert","lines":["g"],"id":8}],[{"start":{"row":147,"column":23},"end":{"row":147,"column":24},"action":"insert","lines":["g"],"id":9}],[{"start":{"row":147,"column":24},"end":{"row":147,"column":25},"action":"insert","lines":["e"],"id":10}],[{"start":{"row":147,"column":25},"end":{"row":147,"column":26},"action":"insert","lines":["r"],"id":11}],[{"start":{"row":147,"column":26},"end":{"row":147,"column":27},"action":"insert","lines":[","],"id":12}],[{"start":{"row":147,"column":27},"end":{"row":147,"column":28},"action":"insert","lines":[" "],"id":13}],[{"start":{"row":147,"column":20},"end":{"row":147,"column":21},"action":"insert","lines":["s"],"id":32}],[{"start":{"row":147,"column":21},"end":{"row":147,"column":22},"action":"insert","lines":["e"],"id":33}],[{"start":{"row":147,"column":22},"end":{"row":147,"column":23},"action":"insert","lines":["r"],"id":34}],[{"start":{"row":147,"column":23},"end":{"row":147,"column":24},"action":"insert","lines":["v"],"id":35}],[{"start":{"row":147,"column":24},"end":{"row":147,"column":25},"action":"insert","lines":["e"],"id":36}],[{"start":{"row":147,"column":25},"end":{"row":147,"column":26},"action":"insert","lines":["r"],"id":37}],[{"start":{"row":147,"column":26},"end":{"row":147,"column":27},"action":"insert","lines":[","],"id":38}],[{"start":{"row":147,"column":27},"end":{"row":147,"column":28},"action":"insert","lines":[" "],"id":39}],[{"start":{"row":147,"column":28},"end":{"row":147,"column":29},"action":"insert","lines":["l"],"id":40}],[{"start":{"row":147,"column":29},"end":{"row":147,"column":30},"action":"insert","lines":["o"],"id":41}],[{"start":{"row":147,"column":30},"end":{"row":147,"column":31},"action":"insert","lines":["g"],"id":42}],[{"start":{"row":147,"column":31},"end":{"row":147,"column":32},"action":"insert","lines":["g"],"id":43}],[{"start":{"row":147,"column":32},"end":{"row":147,"column":33},"action":"insert","lines":["e"],"id":44}],[{"start":{"row":147,"column":33},"end":{"row":147,"column":34},"action":"insert","lines":["r"],"id":45}],[{"start":{"row":147,"column":34},"end":{"row":147,"column":35},"action":"insert","lines":[","],"id":46}],[{"start":{"row":147,"column":35},"end":{"row":147,"column":36},"action":"insert","lines":[" "],"id":47}],[{"start":{"row":147,"column":36},"end":{"row":147,"column":37},"action":"insert","lines":["m"],"id":48}],[{"start":{"row":147,"column":37},"end":{"row":147,"column":38},"action":"insert","lines":["o"],"id":49}],[{"start":{"row":147,"column":38},"end":{"row":147,"column":39},"action":"insert","lines":["n"],"id":50}],[{"start":{"row":147,"column":39},"end":{"row":147,"column":40},"action":"insert","lines":["g"],"id":51}],[{"start":{"row":147,"column":40},"end":{"row":147,"column":41},"action":"insert","lines":["o"],"id":52}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["l"],"id":53}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["o"],"id":54}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["g"],"id":55}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["g"],"id":56}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["e"],"id":57}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["r"],"id":58}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":[","],"id":59}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":[" "],"id":60}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["s"],"id":61}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["e"],"id":62}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["r"],"id":63}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["v"],"id":64}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["e"],"id":65}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["r"],"id":66}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":[","],"id":67}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["c"],"id":68}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["o"],"id":69}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["n"],"id":70}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["f"],"id":71}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["i"],"id":72}],[{"start":{"row":147,"column":41},"end":{"row":147,"column":42},"action":"remove","lines":["g"],"id":73}],[{"start":{"row":152,"column":17},"end":{"row":152,"column":18},"action":"remove","lines":["s"],"id":74}],[{"start":{"row":152,"column":17},"end":{"row":152,"column":18},"action":"remove","lines":["t"],"id":75}],[{"start":{"row":152,"column":17},"end":{"row":152,"column":18},"action":"remove","lines":["a"],"id":76}],[{"start":{"row":152,"column":17},"end":{"row":152,"column":18},"action":"remove","lines":["t"],"id":77}],[{"start":{"row":152,"column":17},"end":{"row":152,"column":18},"action":"remove","lines":["u"],"id":78}],[{"start":{"row":152,"column":17},"end":{"row":152,"column":18},"action":"remove","lines":["s"],"id":79}],[{"start":{"row":154,"column":0},"end":{"row":155,"column":58},"action":"remove","lines":["    server.get('/ipaddress', httpGetIpAddress); //http://url/ipaddress","    //server.get('/ipaddress/help', httpGetIpAddressHelp);"],"id":80}],[{"start":{"row":154,"column":0},"end":{"row":155,"column":4},"action":"remove","lines":["","    "],"id":81}],[{"start":{"row":159,"column":18},"end":{"row":159,"column":25},"action":"remove","lines":["devices"],"id":82},{"start":{"row":159,"column":18},"end":{"row":159,"column":19},"action":"insert","lines":["m"]}],[{"start":{"row":159,"column":19},"end":{"row":159,"column":20},"action":"insert","lines":["o"],"id":83}],[{"start":{"row":159,"column":20},"end":{"row":159,"column":21},"action":"insert","lines":["t"],"id":84}],[{"start":{"row":159,"column":21},"end":{"row":159,"column":22},"action":"insert","lines":["e"],"id":85}],[{"start":{"row":159,"column":22},"end":{"row":159,"column":23},"action":"insert","lines":["s"],"id":86}],[{"start":{"row":159,"column":11},"end":{"row":159,"column":15},"action":"remove","lines":["post"],"id":87},{"start":{"row":159,"column":11},"end":{"row":159,"column":12},"action":"insert","lines":["g"]}],[{"start":{"row":159,"column":12},"end":{"row":159,"column":13},"action":"insert","lines":["e"],"id":88}],[{"start":{"row":159,"column":13},"end":{"row":159,"column":14},"action":"insert","lines":["t"],"id":89}],[{"start":{"row":160,"column":0},"end":{"row":167,"column":52},"action":"remove","lines":["    //unregister device from the database","    server.del('/devices/:uuid', httpDelDeviceUuid);","    //list all agent's devices","    server.get('/devices', httpGetDevices);","    //get device info from the database","    server.get('/devices/:uuid', httpGetDeviceUuid);","    //update device info on the database","    server.put('/devices/:uuid', httpPutDeviceUuid);"],"id":90}],[{"start":{"row":152,"column":20},"end":{"row":152,"column":33},"action":"remove","lines":["httpGetStatus"],"id":91},{"start":{"row":152,"column":20},"end":{"row":152,"column":21},"action":"insert","lines":["f"]}],[{"start":{"row":152,"column":21},"end":{"row":152,"column":22},"action":"insert","lines":["u"],"id":92}],[{"start":{"row":152,"column":22},"end":{"row":152,"column":23},"action":"insert","lines":["n"],"id":93}],[{"start":{"row":152,"column":23},"end":{"row":152,"column":24},"action":"insert","lines":["c"],"id":94}],[{"start":{"row":152,"column":24},"end":{"row":152,"column":25},"action":"insert","lines":["t"],"id":95}],[{"start":{"row":152,"column":25},"end":{"row":152,"column":26},"action":"insert","lines":["i"],"id":96}],[{"start":{"row":152,"column":26},"end":{"row":152,"column":27},"action":"insert","lines":["o"],"id":97}],[{"start":{"row":152,"column":27},"end":{"row":152,"column":28},"action":"insert","lines":["n"],"id":98}],[{"start":{"row":152,"column":28},"end":{"row":152,"column":30},"action":"insert","lines":["()"],"id":99}],[{"start":{"row":152,"column":29},"end":{"row":152,"column":30},"action":"insert","lines":["r"],"id":100}],[{"start":{"row":152,"column":30},"end":{"row":152,"column":31},"action":"insert","lines":["e"],"id":101}],[{"start":{"row":152,"column":31},"end":{"row":152,"column":32},"action":"insert","lines":["q"],"id":102}],[{"start":{"row":152,"column":32},"end":{"row":152,"column":33},"action":"insert","lines":[","],"id":103}],[{"start":{"row":152,"column":33},"end":{"row":152,"column":34},"action":"insert","lines":[" "],"id":104}],[{"start":{"row":152,"column":34},"end":{"row":152,"column":35},"action":"insert","lines":["r"],"id":105}],[{"start":{"row":152,"column":35},"end":{"row":152,"column":36},"action":"insert","lines":["e"],"id":106}],[{"start":{"row":152,"column":36},"end":{"row":152,"column":37},"action":"insert","lines":["s"],"id":107}],[{"start":{"row":152,"column":38},"end":{"row":152,"column":40},"action":"insert","lines":["{}"],"id":108}],[{"start":{"row":152,"column":39},"end":{"row":154,"column":4},"action":"insert","lines":["","        ","    "],"id":109}],[{"start":{"row":154,"column":8},"end":{"row":188,"column":7},"action":"remove","lines":["//http://url/status","    //server.get('/status/help',httpGetStatusHelp );","","    /////////////////////////////////////////////","    //DEVICES","    /////////////////////////////////////////////","    //register device","    server.get('/motes', httpPostDevices); //curl -X POST -d\"name=xxx%uuid=yyy\" http://url/devices","","    ","    //DEVICES/DISCOVER","    /////////////////////////////////////////////","    //Check if CoAP device is on-line and update resource map","    server.get('/devices/discover/direct/:uuid', httpGetDeviceDiscoverDirectUuid);","    //Check if CoAP device is on-line and update resource map","    server.get(/^(\\/devices\\/query\\/direct\\/)([a-zA-Z0-9-]+)(\\/.*)/, httpGetDeviceQueryDirect);","    ","    server.get(/^(\\/devices\\/observe\\/direct\\/)([a-zA-Z0-9-]+)(\\/.*)/, httpGetDeviceObserveDirect);","    ","    //Check if CoAP device is on-line and update resource map","    server.get('/devices/scan/:ip',function httpGetDevicesScanIp(req,res){","        res.setHeader('Access-Control-Allow-Origin','*');","        u.logHttpRequest(req);","        //data.authorize(req.headers.auth_uuid,req.headers.auth_token, function(err,authed){","            if(err) u.handleError(err,res);","            for (var i = 1; i <= 10000; i++) {","            ","                coapClient.discover(req.params.ip, i,function(err,coapRes){","                    if(err) console.log(err);","                    //TODO: add to database or update database","                    console.log(coapRes.rsinfo);","                });","            }","        //});","    });"],"id":110}],[{"start":{"row":3,"column":0},"end":{"row":145,"column":1},"action":"remove","lines":["function httpGetRoot(req, res){","    res.setHeader('content-type','text/plain');","    res.send(help.top);","    u.logHttpRequest(req,res);","}","","function httpGetStatus(req, res){","    res.setHeader('Access-Control-Allow-Origin','*');","    res.json(200,{status: 'DiSoNa on-line'});","    u.logHttpRequest(req,res);","}","","function httpGetStatusHelp(req, res){","    res.setHeader('content-type','text/plain');","    res.send(help.status);","    u.logHttpRequest(req,res);","}","","function httpGetIpAddress(req, res){","    res.setHeader('Access-Control-Allow-Origin','*');","    res.json(200,{ipaddress: u.getRemoteHttpIp(req)});","    u.logHttpRequest(req,res);","}","    ","function httpGetIpAddressHelp(req, res){","    res.setHeader('content-type','text/plain');","    res.send(help.ipaddress);","    u.logHttpRequest(req,res);","}","","function httpPostDevices(req,res){","    var registerDevice = require(\"./deviceRegister.js\");","    res.setHeader('Access-Control-Allow-Origin','*');","    req.params.ipAddress = req.params.ipAddress || u.getRemoteHttpIp(req);","    registerDevice(config, req.params, function(err,device){","        if(err) u.handleError(err,res);","        res.json(200,device);","        u.logHttpRequest(req,res);","    });","}","","function httpDelDeviceUuid(req, res){","    res.setHeader('Access-Control-Allow-Origin','*');","    //data.authorize(req.headers.auth_uuid,req.headers.auth_token, function(err,authed){","        //if(err) u.handleError(err,res);","        devUnregister.unregisterDevice(req.params.uuid, function dbUnregisterDevice(err,data){","            if(err) u.handleError(err,res);","            res.json(200,data);","            u.logHttpRequest(req,res);","        });","    //});","}","","function httpGetDevices(req,res){","    res.setHeader('Access-Control-Allow-Origin','*');","    //data.authorize(req.headers.auth_uuid,req.headers.auth_token, function(err,authed){","        //if(err) u.handleError(err,res);","        devFind.findAll(function httpGetDevices(err,devices){","            if(err) u.handleError(err,res);","            res.json(200,{data: devices});","            u.logHttpRequest(req,res);","        });","    //});","}","","function httpGetDeviceUuid(req, res){","    res.setHeader('Access-Control-Allow-Origin','*');","    //data.authorize(req.headers.auth_uuid,req.headers.auth_token, function(err,authed){","        //if(err) u.handleError(err,res);","        devFind.findByUuids(req.params.uuid, function(err,device){","            if(err) u.handleError(err,res);","            res.json(200,device);","            u.logHttpRequest(req,res);","        });","    //});","}","","function httpPutDeviceUuid(req, res){","    res.setHeader('Access-Control-Allow-Origin','*');","    //data.authorize(req.headers.auth_uuid,req.headers.auth_token, function(err,authed){","        //if(err) u.handleError(err,res);","        devUpdate.updateDevice(req.params.uuid, req.params, function(err,device){","            if(err) u.handleError(err,res);","            res.json(200,device);","            u.logHttpRequest(req,res);","        });","    //});","}","    ","function httpGetDeviceDiscoverDirectUuid(req,res){","    res.setHeader('Access-Control-Allow-Origin','*');","    //data.authorize(req.headers.auth_uuid,req.headers.auth_token, function(err,authed){","        //if(err) u.handleError(err,res);","        devFind.findByUuids(req.params.uuid, function(err,device){","            if(err) u.handleError(err,res);","            coapClient.discover(device.hostName || device.ipAddress, device.port,function(err,coapRes){","                if(err) u.handleError(err,res);","                //var map = u.linkFormatToJson(coapRes.payload.toString());","                var map = JSON.parse(coapRes.payload.toString());","                var data = {","                    mapping: map,","                    online: true","                };","                devUpdate.updateDevice(device.uuid,data, function(err,device){","                    if(err) u.handleError(err,res);","                    res.json(map);","                    u.logHttpRequest(req,res);","                });","            });","        });","    //});","}","","function httpGetDeviceQueryDirect(req,res){","    res.setHeader('Access-Control-Allow-Origin','*');","    //this is to get a non regex representation of the path","    req.route.path = req.params[0] + req.params[1] + req.params[2];","    //data.authorize(req.headers.auth_uuid,req.headers.auth_token, function(err,authed){","        //if(err) u.handleError(err,res);","        devFind.findByUuids(req.params[1], function(err,device){","            if(err) u.handleError(err,res);","            coapClient.queryResource(device, req.params[2], function(err,data){","                if(err) u.handleError(err,res);","                res.json(JSON.parse(data.payload.toString()));","                u.logHttpRequest(req,res);","            });","        });","    //});","}","","function httpGetDeviceObserveDirect(req,res){","    //res.setHeader('Access-Control-Allow-Origin','*');","    //this is to get a non regex representation of the path","    req.route.path = req.params[0] + req.params[1] + req.params[2];","    //data.authorize(req.headers.auth_uuid,req.headers.auth_token, function(err,authed){","        //if(err) u.handleError(err,res);","        devFind.findByUuids(req.params[1], function(err,device){","            if(err) u.handleError(err,res);","            coapClient.observeResource(device, req, res);","            //u.logHttpRequest(req,res);","        });","    //});","}"],"id":111}],[{"start":{"row":3,"column":0},"end":{"row":4,"column":0},"action":"remove","lines":["",""],"id":112}],[{"start":{"row":3,"column":0},"end":{"row":4,"column":0},"action":"remove","lines":["",""],"id":113}],[{"start":{"row":4,"column":0},"end":{"row":6,"column":49},"action":"remove","lines":["    //////////////////////////////////////////////","    //BASIC QUERIES","    /////////////////////////////////////////////"],"id":114}],[{"start":{"row":1,"column":0},"end":{"row":1,"column":2},"action":"insert","lines":["//"],"id":115,"ignore":true}]],"mark":100,"position":100},"ace":{"folds":[],"customSyntax":"javascript","scrolltop":0,"scrollleft":0,"selection":{"start":{"row":11,"column":28},"end":{"row":11,"column":28},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":89,"mode":"ace/mode/javascript"}},"timestamp":1431855775619,"hash":"f8f94717ee853a6de7006b828bc2ca1d31ff080b"}